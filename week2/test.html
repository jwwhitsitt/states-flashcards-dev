<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Week 2 – Check Your Learning</title>

  <!--
    test.html — v2.3 (dev)
    Only agreed changes included:
    - Capitals (Q2) uses UNDERSCORE slots (already in your working build)
    - Two-word states display on TWO centered lines (no space tile)
    - Keep everything else as-is: auto-advance after feedback, big buttons, all-caps letters
  -->

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --shadow:0 10px 30px rgba(15,23,42,.12);
      --radius:18px;
      --link:#1d4ed8;

      --btn:#0f172a;
      --btn2:#e5e7eb;
      --btn2text:#111827;

      --bar:#c7d2fe;
      --barbg:#e5e7eb;

      --ok:#22c55e;
      --bad:#ef4444;

      --slot:#9aa4b2;
      --tileBorder:#e5e7eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      padding:10px 14px;
      background:#fff;
      box-shadow:0 1px 10px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
    }
    header a{
      text-decoration:none;
      color:var(--link);
      font-weight:900;
      white-space:nowrap;
    }
    header h1{
      margin:0;
      font-size:16px;
      font-weight:1000;
      text-align:center;
      flex:1;
    }
    header .spacer{ width:52px; }

    main{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:12px;
      overflow:hidden;
    }
    .wrap{
      width:100%;
      max-width:720px;
      min-height:0;
    }

    .toprow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .pill{
      background:#dbeafe;
      color:#1e3a8a;
      font-weight:1000;
      border-radius:999px;
      padding:8px 12px;
      font-size:14px;
      min-width:92px;
      text-align:center;
      white-space:nowrap;
    }
    .barwrap{
      flex:1;
      height:18px;
      background:var(--barbg);
      border-radius:999px;
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .bar{
      height:100%;
      width:0%;
      background:var(--bar);
      border-radius:999px;
      transition:width .25s ease;
    }
    .bartext{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#111827;
      font-size:14px;
      text-shadow:0 1px 0 rgba(255,255,255,.75);
      pointer-events:none;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:calc(100vh - 62px - 24px - 34px);
      max-height:760px;
      overflow:hidden;
    }

    /* ===== shared image box for spelling ===== */
    .imgbox{
      border-radius:16px;
      background:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      padding:10px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
      height:210px;
      overflow:hidden;
    }
    .imgbox.show{ display:flex; }
    .imgbox img{
      width:100%;
      height:100%;
      object-fit:contain;
      border-radius:12px;
    }

    .qtitle{
      font-size:44px;
      font-weight:1000;
      line-height:1.05;
      margin-top:2px;
      letter-spacing:-.5px;
    }
    .qsub{
      color:var(--muted);
      font-weight:900;
      font-size:22px;
      margin-bottom:2px;
    }

    /* ===== Q1/Q3 multiple choice ===== */
    .answers{
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1;
      min-height:0;
      overflow:hidden;
      justify-content:flex-start;
    }
    .choice{
      border-radius:18px;
      border:2px solid #e5e7eb;
      background:#fff;
      padding:18px 16px;
      font-size:26px;
      font-weight:1000;
      text-align:left;
      cursor:pointer;
      transition:transform .05s ease, border-color .1s ease, background .1s ease;
    }
    .choice:active{ transform:scale(.995); }
    .choice.correct{
      border-color:var(--ok);
      background:#ecfdf5;
    }
    .choice.wrong{
      border-color:var(--bad);
      background:#fef2f2;
    }
    .choice:disabled{
      color:#9ca3af;
    }

    /* ===== Q2 capitals tiles ===== */
    .capWrap{
      display:none;
      flex-direction:column;
      gap:12px;
      flex:1;
      min-height:0;
      overflow:hidden;
    }
    .capWrap.show{ display:flex; }

    /* Slots container (changed to support 2 centered lines) */
    .slots{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 10px;
      border-radius:16px;
      background:#fff;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
      overflow:hidden;
      transition: box-shadow .15s ease;
    }
    .slots.ok{
      box-shadow: inset 0 0 0 2px rgba(34,197,94,.75);
    }
    .slots.bad{
      box-shadow: inset 0 0 0 2px rgba(239,68,68,.75);
    }

    /* A row of slots for each word */
    .slotRow{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:minmax(10px, 1fr);
      gap:10px;
      width:fit-content;
      max-width:100%;
      justify-content:center;
    }

    /* Individual underscore slot */
    .slot{
      width:auto;
      min-width:22px;
      text-align:center;
      border-bottom:4px solid var(--slot);
      padding-bottom:6px;
      line-height:1;
      font-weight:1000;
      font-size:20px;
      color:#111827;
      user-select:none;
    }
    .slot.empty{ color:transparent; }

    .tileGrid{
      width:100%;
      display:grid;
      grid-template-columns:repeat(6, minmax(0, 1fr));
      gap:12px;
      justify-content:center;
      align-content:start;
      padding:6px 4px;
      overflow:hidden;
    }

    .tile{
      border-radius:18px;
      border:2px solid var(--tileBorder);
      background:#fff;
      padding:14px 0;
      font-size:26px;
      font-weight:1000;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition:transform .05s ease, opacity .12s ease, border-color .12s ease;
    }
    .tile:active{ transform:scale(.99); }
    .tile.used{
      opacity:.25;
      pointer-events:none;
    }

    /* Bottom buttons (big) */
    .bottom{
      display:flex;
      gap:12px;
      margin-top:2px;
    }
    .btn{
      flex:1;
      padding:18px 16px;
      border-radius:18px;
      border:0;
      font-size:22px;
      font-weight:1000;
      cursor:pointer;
      background:var(--btn);
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.10);
    }
    .btn.secondary{
      background:var(--btn2);
      color:var(--btn2text);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .result{
      text-align:center;
      font-weight:1000;
      color:var(--muted);
      font-size:14px;
      margin-top:2px;
      min-height:18px;
    }

    .review{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      background:#f8fafc;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
      overflow:auto;
      max-height:220px;
    }
    .review h2{
      margin:0 0 6px 0;
      font-size:16px;
      font-weight:1000;
    }
    .review ul{
      margin:0;
      padding-left:18px;
      color:#111827;
      font-weight:800;
    }
    .small{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <header>
    <a href="./index.html">← Back</a>
    <h1>Check Your Learning</h1>
    <div class="spacer"></div>
  </header>

  <main>
    <div class="wrap">

      <div class="toprow">
        <div class="pill" id="sectionPill">Spelling</div>
        <div class="barwrap" aria-label="Progress">
          <div class="bar" id="bar"></div>
          <div class="bartext" id="barText">1 of 12</div>
        </div>
      </div>

      <section class="card" id="card">
        <!-- Spelling image -->
        <div class="imgbox" id="imgbox"><img id="img" alt="" /></div>

        <!-- Titles -->
        <div class="qtitle" id="qtitle"></div>
        <div class="qsub" id="qsub"></div>

        <!-- Q1/Q3 answers -->
        <div class="answers" id="answers"></div>

        <!-- Q2 capitals UI -->
        <div class="capWrap" id="capWrap">
          <div class="slots" id="slots"></div>
          <div class="tileGrid" id="tileGrid"></div>

          <div class="bottom">
            <button class="btn secondary" id="capClearBtn" type="button">Clear</button>
            <button class="btn" id="capCheckBtn" type="button">Check</button>
          </div>
        </div>

        <!-- Bottom controls (Q1/Q3 only; auto-advance means Next stays hidden) -->
        <div class="bottom" id="bottomRow">
          <button class="btn secondary" id="exitBtn" type="button">Exit</button>
          <button class="btn" id="nextBtn" type="button" disabled>Next</button>
        </div>

        <div class="result" id="result"></div>
        <div id="reviewBox" style="display:none;"></div>
      </section>
    </div>
  </main>

  <script>
    // ====== Data ======
    const WEEK = [
      { state:"Pennsylvania", abbrev:"PA", capital:"Harrisburg", img:"./images/pa-f.png" },
      { state:"New Jersey",   abbrev:"NJ", capital:"Trenton",    img:"./images/nj-f.png" },
      { state:"New York",     abbrev:"NY", capital:"Albany",     img:"./images/ny-f.png" },
      { state:"Delaware",     abbrev:"DE", capital:"Dover",      img:"./images/de-f.png" }
    ];

    // Spelling fakes (must ALWAYS include correct spelling among 4 choices)
    const SPELLING_FAKES = {
      "Pennsylvania":["Pensylvainia","Pencilvainya","Penzylvania"],
      "New Jersey":["New Jerzee","New Jersie","New Jersei"],
      "New York":["New Yorc","New Yark","Nu York"],
      "Delaware":["Delawair","Delawere","Della-ware"]
    };

    const ABBREV_POOL = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD",
                         "MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC",
                         "SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function pickDistinct(pool, count, excludeSet){
      const out = [];
      const p = shuffle(pool).filter(x => !excludeSet.has(x));
      for(const item of p){
        if(out.length>=count) break;
        out.push(item);
      }
      return out;
    }

    // ====== Build questions (12 total: 4 spelling, 4 capitals tiles, 4 abbreviations) ======
    const spellingQuestions = WEEK.map(s => {
      const correct = s.state;
      const fakes = shuffle(SPELLING_FAKES[correct] || []).slice(0,3);
      const choices = shuffle([correct, ...fakes]).slice(0,4); // ensure 4
      // safety: if somehow correct got chopped (shouldn't), force it in
      if(!choices.includes(correct)){
        choices[0] = correct;
      }
      return {
        type:"spelling",
        section:"Spelling",
        showImage:true,
        img:s.img,
        title:"Pick the correct spelling",
        subtitle:"Which one is spelled correctly?",
        correct,
        choices
      };
    });

    const capitalQuestions = WEEK.map(s => {
      return {
        type:"capitals",
        section:"Capitals",
        showImage:false,
        img:null,
        title:s.capital,
        subtitle:"Tap the letters to spell the state.",
        correct:s.state
      };
    });

    const abbrevQuestions = WEEK.map(s => {
      const correct = s.abbrev;
      const wrongs = pickDistinct(ABBREV_POOL, 3, new Set([correct]));
      const choices = shuffle([correct, ...wrongs]);
      return {
        type:"abbrev",
        section:"Abbreviations",
        showImage:false,
        img:null,
        title:s.state,
        subtitle:"Which abbreviation matches this state?",
        correct,
        choices
      };
    });

    const QUESTIONS = [...spellingQuestions, ...capitalQuestions, ...abbrevQuestions];

    // ====== UI hooks ======
    const sectionPill = document.getElementById("sectionPill");
    const bar = document.getElementById("bar");
    const barText = document.getElementById("barText");

    const imgbox = document.getElementById("imgbox");
    const img = document.getElementById("img");
    const qtitle = document.getElementById("qtitle");
    const qsub = document.getElementById("qsub");
    const answersEl = document.getElementById("answers");
    const resultEl = document.getElementById("result");
    const reviewBox = document.getElementById("reviewBox");

    const bottomRow = document.getElementById("bottomRow");
    const exitBtn = document.getElementById("exitBtn");
    const nextBtn = document.getElementById("nextBtn");

    const capWrap = document.getElementById("capWrap");
    const slotsEl = document.getElementById("slots");
    const tileGrid = document.getElementById("tileGrid");
    const capClearBtn = document.getElementById("capClearBtn");
    const capCheckBtn = document.getElementById("capCheckBtn");

    // ====== State ======
    let idx = 0;
    let locked = false;

    const results = []; // {q, chosen, correct, ok}
    const missed = new Set();

    // capitals working state
    let capAnswer = [];      // array of letters filled (no spaces)
    let capTarget = "";      // target letters (no spaces)
    let capTiles = [];       // tile letters (upper)
    let capUsed = [];        // bools
    let capWordParts = [];   // ["NEW","YORK"] or ["DELAWARE"]

    const AUTO_DELAY = 500; // agreed: quick feedback then auto-advance

    function setProgress(){
      const n = QUESTIONS.length;
      const pos = Math.min(idx + 1, n);
      const pct = Math.round((pos / n) * 100);
      bar.style.width = pct + "%";
      barText.textContent = `${pos} of ${n}`;
      sectionPill.textContent = QUESTIONS[idx].section;
    }

    function resetFeedback(){
      resultEl.textContent = "";
      slotsEl.classList.remove("ok","bad");
    }

    function renderQuestion(){
      locked = false;
      resetFeedback();
      reviewBox.style.display = "none";
      reviewBox.innerHTML = "";

      const q = QUESTIONS[idx];
      setProgress();

      // image rules (spelling only)
      if(q.showImage && q.img){
        imgbox.classList.add("show");
        img.src = q.img;
        img.alt = "State flashcard";
      } else {
        imgbox.classList.remove("show");
        img.src = "";
        img.alt = "";
      }

      qtitle.textContent = q.title;
      qsub.textContent = q.subtitle;

      // show/hide sections
      answersEl.style.display = "none";
      capWrap.classList.remove("show");
      bottomRow.style.display = "none";
      answersEl.innerHTML = "";

      if(q.type === "spelling" || q.type === "abbrev"){
        // MC mode
        answersEl.style.display = "flex";
        bottomRow.style.display = "flex";
        nextBtn.disabled = true; // auto-advance, so keep disabled
        nextBtn.style.display = "none"; // hide Next (agreed: no user tap Next)
        exitBtn.style.display = "block";

        q.choices.forEach(choice => {
          const b = document.createElement("button");
          b.className = "choice";
          b.type = "button";
          b.textContent = choice;
          b.addEventListener("click", () => chooseMC(choice));
          answersEl.appendChild(b);
        });
      }

      if(q.type === "capitals"){
        // Capitals tiles mode
        capWrap.classList.add("show");
        bottomRow.style.display = "none"; // uses its own buttons (Clear/Check)
        buildCapitalsUI(q.correct);
      }
    }

    function chooseMC(choice){
      if(locked) return;
      locked = true;

      const q = QUESTIONS[idx];
      const ok = (choice === q.correct);

      const btns = Array.from(document.querySelectorAll(".choice"));
      btns.forEach(b => {
        if(b.textContent === q.correct) b.classList.add("correct");
        else if(b.textContent === choice) b.classList.add("wrong");
        b.disabled = true;
      });

      if(ok){
        resultEl.textContent = "✅ Nice!";
      } else {
        resultEl.textContent = "❌ Almost — keep going.";
        missed.add(`${q.section}: ${q.title}`);
      }

      results.push({ q, chosen: choice, correct: q.correct, ok });

      setTimeout(() => {
        advanceOrSummary();
      }, AUTO_DELAY);
    }

    // ====== Capitals tiles (underscore slots) ======
    function buildCapitalsUI(stateName){
      // agreed: ALL CAPS display for tiles/slots
      capWordParts = stateName.trim().toUpperCase().split(/\s+/); // words only
      capTarget = capWordParts.join(""); // no spaces
      capAnswer = Array.from({length: capTarget.length}, () => "");
      capTiles = shuffle(capTarget.split("")); // ONLY letters in the name
      capUsed = capTiles.map(() => false);

      // build slots as 1 row or 2 rows depending on words (agreed: 2 lines for 2-word states)
      slotsEl.classList.remove("ok","bad");
      slotsEl.innerHTML = "";

      // create one row per word, centered
      let globalIndex = 0;
      capWordParts.forEach(word => {
        const row = document.createElement("div");
        row.className = "slotRow";
        for(let i=0;i<word.length;i++){
          const s = document.createElement("div");
          s.className = "slot empty";
          s.dataset.slotIndex = String(globalIndex);
          s.textContent = "_";            // will be hidden via transparent when empty
          s.classList.add("empty");
          s.textContent = "A";            // placeholder for height consistency; hidden when empty
          s.classList.add("empty");
          row.appendChild(s);
          globalIndex++;
        }
        slotsEl.appendChild(row);
      });

      // render tiles (6 columns)
      renderTileGrid();

      // wire buttons
      capClearBtn.disabled = false;
      capCheckBtn.disabled = false;

      // initial paint of slots
      repaintSlots();
    }

    function renderTileGrid(){
      tileGrid.innerHTML = "";
      capTiles.forEach((ch, i) => {
        const t = document.createElement("button");
        t.type = "button";
        t.className = "tile" + (capUsed[i] ? " used" : "");
        t.textContent = ch;
        t.addEventListener("click", () => onTileTap(i));
        tileGrid.appendChild(t);
      });
    }

    function nextEmptySlotIndex(){
      for(let i=0;i<capAnswer.length;i++){
        if(!capAnswer[i]) return i;
      }
      return -1;
    }

    function onTileTap(tileIndex){
      if(locked) return;
      if(capUsed[tileIndex]) return;

      const slotIndex = nextEmptySlotIndex();
      if(slotIndex === -1) return;

      capAnswer[slotIndex] = capTiles[tileIndex];
      capUsed[tileIndex] = true;

      repaintSlots();
      renderTileGrid();
    }

    function repaintSlots(){
      // fill each slot by global index (across rows)
      const allSlots = slotsEl.querySelectorAll(".slot");
      allSlots.forEach(slotEl => {
        const i = Number(slotEl.dataset.slotIndex);
        const v = capAnswer[i] || "";
        if(v){
          slotEl.textContent = v;
          slotEl.classList.remove("empty");
        } else {
          slotEl.textContent = "A"; // keep height; hidden by empty class
          slotEl.classList.add("empty");
        }
      });
    }

    function clearCapitals(){
      if(locked) return;
      capAnswer = capAnswer.map(() => "");
      capUsed = capUsed.map(() => false);
      slotsEl.classList.remove("ok","bad");
      repaintSlots();
      renderTileGrid();
      resetFeedback();
    }

    function checkCapitals(){
      if(locked) return;

      // if not fully filled, treat as incorrect (but still show feedback)
      const attempt = capAnswer.join("");
      const ok = (attempt === capTarget);

      locked = true;

      if(ok){
        slotsEl.classList.add("ok");
        resultEl.textContent = "✅ Nice!";
      } else {
        slotsEl.classList.add("bad");
        resultEl.textContent = "❌ Almost — keep going.";
        const q = QUESTIONS[idx];
        missed.add(`${q.section}: ${q.title}`);
      }

      const q = QUESTIONS[idx];
      results.push({ q, chosen: attempt, correct: capTarget, ok });

      setTimeout(() => {
        locked = false; // allow next screen interactions
        advanceOrSummary();
      }, AUTO_DELAY);
    }

    capClearBtn.addEventListener("click", clearCapitals);
    capCheckBtn.addEventListener("click", checkCapitals);

    // ====== Advance / Summary ======
    function advanceOrSummary(){
      if(idx >= QUESTIONS.length - 1){
        showSummary();
        return;
      }
      idx++;
      renderQuestion();
    }

    function showSummary(){
      // compute score
      const total = results.length;
      const correct = results.filter(r => r.ok).length;
      const pct = Math.round((correct / Math.max(1,total)) * 100);

      // wipe interactive areas
      imgbox.classList.remove("show");
      answersEl.innerHTML = "";
      answersEl.style.display = "none";
      capWrap.classList.remove("show");
      bottomRow.style.display = "none";

      // titles
      qtitle.textContent = `Score: ${pct}%`;
      qsub.textContent = `You got ${correct} out of ${total} correct.`;

      const misses = Array.from(missed);

      // tip text: special case for 100%
      let tip;
      if(pct === 100){
        tip = "Perfect score! Keep it up — a quick review later helps it stick.";
      } else {
        tip = "Tip: Go back to Study, then try again.";
      }

      const reviewHtml = `
        <div class="review">
          <h2>${misses.length ? "Review these:" : "Nothing to review — nice work!"}</h2>
          ${misses.length ? `<ul>${misses.map(m => `<li>${m}</li>`).join("")}</ul>` : ""}
          <div class="small">${tip}</div>
        </div>
      `;

      reviewBox.style.display = "block";
      reviewBox.innerHTML = reviewHtml;

      // Put the main button near the top (reduces huge white space on tall screens)
      const topButton = document.createElement("div");
      topButton.className = "bottom";
      topButton.style.marginTop = "8px";
      topButton.innerHTML = `<button class="btn secondary" type="button" id="backToWeekBtn">Back to Week 2</button>`;
      reviewBox.prepend(topButton);

      document.getElementById("backToWeekBtn").addEventListener("click", () => {
        window.location.href = "./index.html";
      });

      // progress bar full
      bar.style.width = "100%";
      barText.textContent = `${total} of ${total}`;
      sectionPill.textContent = "Done";
    }

    // Exit always returns to week menu
    exitBtn.addEventListener("click", () => {
      window.location.href = "./index.html";
    });

    // (Next hidden; kept only as fallback)
    nextBtn.addEventListener("click", () => advanceOrSummary());

    // start
    renderQuestion();
  </script>
</body>
</html>